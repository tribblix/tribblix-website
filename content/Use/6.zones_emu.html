---
title: emu Zones
---
<h1>&gt; emu Zones</h1>

<p>The emu brand allows you to run virtual machines under qemu, similar to
the implementation for <a href="6.zones_bhyve.html">bhyve</a>.</p>

<p>This is an <b>experimental</b> feature, introduced in Tribblix m38.</p>

<p>To run zones using the emu brand, first ensure that the qemu
overlay is installed</p>
<pre>
  zap install-overlay qemu
</pre>

<p>To boot a guest, the command would be something like:</p>
<pre>
  zap create-zone -t emu -z emu1 \
    -x 192.168.0.236  \
    -I /var/tmp/tribblix-0m38.iso \
    -M x86_64:max \
    -V 8G
</pre>
<p>Here, the <code>-t</code> flag tells us that this is an emu zone, the
<code>-z</code> flag gives the name of the zone, the <code>-x</code>
flag specifies the zone's permitted IP address, the <code>-I</code> flag
tells qemu where to find the ISO image to boot from, and the <code>-V</code>
flag says to create an 8G virtual disk for the guest to use.</p>

<p>The key difference with emu zones is that you need to specify the cpu
details with the <code>-M</code> flag. Currently this takes 2 fields separated
by a colon; the first field maps directly to the qemu binary to use (ie.
qemu-system-x86_64), the second field is the cpu model. You can get the list
of available cpu models by running qemu with the <code>-cpu help</code> flags.
</p>

<p>You can set the number of vcpus for the guest with the <code>-c</code>
flag (the default is a single cpu). Likewise, the guest memory can be set
with the <code>-m</code> flag (the default is 1G of memory). As an example,
add <code>-c 2 -m 2G</code>.</p>

<p>That will create and boot the zone. To interact with it, use VNC. As
root, start up <code>socat</code> like so:</p>
<pre>
  socat TCP-LISTEN:5905,reuseaddr,fork UNIX-CONNECT:/export/zones/emu1/root/tmp/vm.vnc
</pre>
<p>Note the name of the path to the zone, which you'll need to change
depending on the name of the zone. Also, you can choose a different port,
just remember that it must be unique, and the VNC display number is offset
by 5900.</p>

<p>Then, as yourself, you can connect with</p>
<pre>
  vncviewer :5
</pre>
<p>and you should see, and be able to interact with, the system as it boots.</p>

<p>There's a slightly more convenient way to view the graphical console
without the manual mucking about with socat and vncviewer described above.
If you share your user account with the zone using the <code>-U</code>
flag (which in the case of emu zones means sharing with the zone and not
with the OS running as the guest):</p>
<pre>
  zap create-zone -t emu -z emu1 -U ptribble ...
</pre>
<p>then the <a href="/man/man1/startvnc.html">startvnc</a> command can be
used to connect to the VNC console as that user, like so:</p>
<pre>
  startvnc -Z emu1
</pre>
<p>This trick actually moves the socket into a dedicated location, which will
be <code>/var/zap/emu/emu1/vm.vnc</code> in the global zone, but only
accessible to the user you shared the zone with. So if you want to use
socat you'll have to change the filename. If you're running the emu zone
on a remote server, you can tunnel the VNC socket with ssh, like so:</p>
<pre>
  ssh -L 5905:/var/zap/emu/emu1/vm.vnc my.server.name
</pre>
<p>
and then on the desktop machine point your VNC client at :5.
</p>

<p>You can run the installer as normal. But before you can use the installed
system you need to remove the virtual CD and reboot.</p>
<pre>
  zap remove-cd -z emu1 -r
</pre>

<h2>Cloud-init</h2>

<p>Often, you'll want the guest to automatically configure itself.
You can use <code>cloud-init</code> for this.</p>

<p>Adding the <code>-C</code> flag to the <code>create-zone</code>
invocation will enable <code>cloud-init</code>. On its own, this doesn't
do a great deal, but should set up the IP address and dns resolution
correctly.</p>

<p>Using the <code>-k</code> flag with the name of an SSH public key file
will enable <code>cloud-init</code> and configure the guest to allow SSH
access to the default account (or root) using the given SSH key. For example,
you might use:</p>
<pre>
  zap create-zone -t emu -z emu2 \
    -x 192.168.0.237  \
    -I /var/tmp/ubuntu-22.04.1-live-server-amd64.iso \
    -k /export/home/ptribble/.ssh/id_rsa.pub \
    -V 8G
</pre>
<hr>
<p><a href="./">Index</a>
 | <a rel="prev" href="6.zones_bhyve.html">Previous Section</a>
 | <a rel="next" href="6.zones_lx.html">Next Section</a>
</p>
